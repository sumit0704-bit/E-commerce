<%- include('./partials/header') %>

<div class="w-full min-h-screen flex px-20 py-20 gap-10">

    <!-- LEFT SIDE : CART ITEMS -->
    <div class="w-[35%] flex flex-col gap-6">

        <% if(user.cart.length === 0){ %>
            <p class="text-xl text-gray-500 mt-10">
                Your cart is empty
            </p>
        <% } %>

        <% 
        // collect unique products
        let uniqueProducts = [];
        user.cart.forEach(item => {
            if (!uniqueProducts.find(p => p._id.toString() === item._id.toString())) {
                uniqueProducts.push(item);
            }
        });
        %>

        <% uniqueProducts.forEach(function(product){ %>

            <% 
                let qty = user.cart.filter(
                    p => p._id.toString() === product._id.toString()
                ).length;

                let finalPrice = product.price - product.discount;
            %>

            <div class="rounded-md overflow-hidden border">

                <!-- IMAGE -->
                <div class="w-full flex justify-center items-center h-80 bg-[#222]">
                    <img 
                        class="h-[18rem]" 
                        src="data:image/jpeg;base64,<%= product.image.toString('base64') %>" 
                        alt=""
                    >
                </div>

                <!-- NAME + QUANTITY -->
                <div class="w-full flex justify-between px-5 py-4">
                    <h3 class="text-2xl"><%= product.name %></h3>

                    <div class="flex items-center gap-3">
                        <a href="/cart/add/<%= product._id %>">
                            <i class="ri-add-line w-7 h-7 bg-white flex items-center justify-center rounded-full"></i>
                        </a>

                        <span class="px-3 py-1 bg-white text-black rounded">
                            <%= qty %>
                        </span>

                        <a href="/cart/remove/<%= product._id %>">
                            <i class="ri-subtract-line w-7 h-7 bg-white flex items-center justify-center rounded-full"></i>
                        </a>
                    </div>
                </div>

                <!-- PRICE -->
                <div class="px-5 pb-3">
                    <div class="flex justify-between">
                        <span>Net Total</span>
                        <span>₹ <%= finalPrice * qty %></span>
                    </div>

                    <div class="text-sm text-gray-500 mt-1">
                        MRP ₹ <%= product.price %> × <%= qty %>
                        <span class="text-green-600">
                            (−₹ <%= product.discount * qty %>)
                        </span>
                    </div>
                </div>

            </div>

        <% }) %>

    </div>

    <!-- RIGHT SIDE : PRICE BREAKDOWN -->
    <div class="w-[65%]">

        <h3 class="text-2xl mb-6">Price Breakdown</h3>

        <div class="space-y-4 w-1/2">

            <div class="flex justify-between">
                <span>Total MRP</span>
                <span>₹ <%= totalMRP %></span>
            </div>

            <div class="flex justify-between">
                <span>Discount on MRP</span>
                <span class="text-green-600">− ₹ <%= totalDiscount %></span>
            </div>

            <div class="flex justify-between">
                <span>Platform Fee</span>
                <span>₹ <%= platformFee %></span>
            </div>

            <div class="flex justify-between">
                <span>Shipping Fee</span>
                <span class="text-green-600">
                    <%= user.cart.length === 0 ? "—" : "FREE" %>
                </span>
            </div>

        </div>

        <div class="w-1/2 h-[1px] bg-black my-8"></div>

        <div class="flex justify-between w-1/2 text-xl font-semibold">
            <span>Total Amount</span>
            <span class="text-green-600">₹ <%= totalAmount %></span>
        </div>

        <% if(user.cart.length === 0){ %>
            <button 
                class="mt-8 px-10 py-3 bg-gray-400 text-white rounded cursor-not-allowed"
                disabled
            >
                Place Order
            </button>
        <% } else { %>
            <button 
                class="mt-8 px-10 py-3 bg-black text-white rounded"
            >
                Place Order
            </button>
        <% } %>

    </div>

</div>

<%- include('./partials/footer') %>
